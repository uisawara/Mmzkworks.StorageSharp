## キャッシュ構成例

いくつかのキャッシュフロー構成の例を紹介します。
どういった用途か・何を高速化したいかで適切な構成は変わってくるので、参考にしつつ求める構成を組んでください。

### キャッシュなしでサーバーからファイルダウンロード

- StorageSharpを使わない構成のイメージです。
- ここにStorageSharpを導入していく際の構成例が以降の例となります。

![image](./img/550e8400-e29b-41d4-a716-446655440000.png)

### ファイルキャッシュ

- 二回目以降のダウンロードの高速化を狙った構成です。
- 構成
  - ダウンロードしたファイルをファイルキャッシュに保存します。
  - 再度リクエストがきた際はキャッシュが使われるのでダウンロード時間の分を高速化できます。
    - クラウド側に負荷がかからないのでコスト削減のメリットがあります。

![image](./img/550e8400-e29b-41d4-a716-446655440001.png)

### ファイルキャッシュ＋ZIP展開

- ダウンロードする対象がZipファイルの場合の例。
- 構成
  - ダウンロードしたZipファイルはファイルとしてキャッシュに保存します。
- 特性
  - 再度リクエストがきた際はキャッシュが使われるのでダウンロード時間の分を高速化できます。
    - クラウド側に負荷がかからないのでコスト削減のメリットがあります。
  - 利用の都度Zip展開します。
    - 毎回展開するのでファイル次第で重いです。

![image](./img/550e8400-e29b-41d4-a716-446655440002.png)

```csharp
var pack = new CachedStorage(
    new SampleAPIStorage(),
    new FileStorage("Cache/Download/"));
var zipFilePath = pack.Load();
// zipFilePathにある.zipを手動でdecompressする
```

### ファイルキャッシュ＋Zip展開＋展開結果をファイルキャッシュ

- 都度Zip展開される時間がかかるのをキャッシュすることで高速化します。
- 構成
  - ZippedPacksを入れることでZipファイルの展開とキャッシュをまるごと委ねます。
  - 2度目以降のリクエストではキャッシュが効くので、ダウンロード＋Zip展開の時間をまるごと短縮できます。
  - Zipファイル、Zip展開後ファイルの一式がローカルストレージに置かれます。
    - ストレージ容量に注意が必要です。
    - ユーザーは展開後ファイルをさわることができるため、さわられたくない場合は注意が必要です。


![image](./img/550e8400-e29b-41d4-a716-446655440003.png)

```csharp
var packages = new ZippedPacks(
    new ZippedPacks.Settings("Tmp/Extracted"),
    new CachedStorage(
        new SampleAPIStorage(),
        new FileStorage("Cache/Download/")));
var decompressedZipPath = await packages.Load(archiveScheme);
```

### メモリキャッシュ＋Zip展開＋展開結果をファイルキャッシュ

- ユーザーにできるだけファイルを見られたくない場合の構成です。
- 構成
  - CacheStorageをMemoryStorageに替えることで物理ファイルとしての保存を止めます。
- 特性
  - Zip展開ファイルが一時的に作成されますが、都度Load(),Unload()を行うことで物理ファイルとして存在する期間をなるだけ短くします。
  - 厳密にはLoad()～Unload()までの期間はファイルが存在するので、完全にファイルを作らないわけではありません。
  - Zipをメモリにキャッシュするのでアプリを起動しなおすと再度ダウンロードが行われます。
  - オンメモリにダウンロードデータが配置されるため、メモリ使用量には注意が必要です。

![image](./img/550e8400-e29b-41d4-a716-446655440004.png)

